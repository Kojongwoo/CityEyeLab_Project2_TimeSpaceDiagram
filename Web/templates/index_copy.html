<!DOCTYPE html>
<html>
<head>
  <title>êµì°¨ë¡œ ì‹œê³µë„ ìƒì„±</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.css" />
  <!-- <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/plugins/copyPaste/copyPaste.js"></script> -->
  <style>
   body {
    font-family: 'Noto Sans KR', sans-serif;
    margin: 20px;
    background-color: #f4f4f4;
    text-align: center;
   }
   h2 {
    color: #333;
    margin-bottom: 15px;
   }
   #file-upload-section, #input-section, #result {
    background-color: #fff;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
   }
   label {
    display: inline-block;
    width: 120px;
    margin-bottom: 10px;
    font-weight: bold;
   }
   input#FileInput, input#direction, input#sa_num, input#end_time {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 150px;
    box-sizing: border-box;
    margin-bottom: 10px;
   }
   button {
    background-color: #5cb85c;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
   }
   button:hover {
    background-color: #4cae4c;
   }
   #hot-container {
    margin-bottom: 20px;
   }
   #result-image-container {
    margin-top: 20px;
    text-align: center;
   }
   #result-image-container img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
   }    
  </style>
</head>

<body>
  <h2>êµì°¨ë¡œ ì •ë³´ ì…ë ¥</h2>
  <div>
    <label for="FileInput">ğŸ—‚ï¸ íŒŒì¼ ì—…ë¡œë“œ (CSV ë˜ëŠ” Excel)</label><br>
    <input type="file" id="FileInput" accept=".csv, .xlsx"><br><br>
  </div>
    <form id="form" action="/generate" method="post">
      <div id="hot"></div>
      ë°©í–¥: <input type="text" id="direction">
      SA_num (ì„ íƒ): <input type="number" id="sa_num">
      ì¢…ë£Œ ì‹œê°„ (ì´ˆ): <input type="number" id="end_time">
      <button type="submit">ì‹œê³µë„ ìƒì„±</button>
      <button type="button" id="saveExcelBtn" style="margin-top: 15px;">ğŸ“¥ ìˆ˜ì •ëœ ì—‘ì…€ ì €ì¥</button>
    </form>
    <div id="result">
        <div id="loading" style="display:none;">
        <p>ì‹œê³µë„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p>
        <img src="/static/loading.gif" alt="ë¡œë”© ì¤‘" width="50">
      </div>
      <div id="image-result">
        {% if image_url %}
          <h2>ê²°ê³¼ ì‹œê³µë„</h2>
          <img src="{{ image_url }}" width="800">
        {% endif %}
      </div>
    </div>
    <script>
      let hot;
      document.getElementById("image-result").innerHTML = "";
      document.addEventListener("DOMContentLoaded", function() {
        const container = document.getElementById('hot');

        hot = new Handsontable(container, {
          data: [],
          rowHeaders: true,
          colHeaders: true,
          width: '100%',
          height: 500,
          manualRowResize: true,      // âœ… í–‰ í¬ê¸° ìˆ˜ë™ ì¡°ì ˆ ê°€ëŠ¥
          stretchH: 'all',            // âœ… ì—´ ë„ˆë¹„ ìë™ í™•ì¥
          copyPaste: true,
          fragmentSelection: true,            // ë³µìˆ˜ ì…€ í´ë¦½ë³´ë“œ ë³µì‚¬ í—ˆìš©
          contextMenu: true,
          licenseKey: 'non-commercial-and-evaluation',
          minSpareRows: 1,
          minRows: 0,
          viewportRowRenderingOffset: 20,
          allowInsertRow: true,
          // allowHtml: true,
          trimWhitespace: true,
          outsideClickDeselects: false,       // ì™¸ë¶€ í´ë¦­í•´ë„ ì…€ ì„ íƒ ìœ ì§€
          pasteMode: 'overwrite', // âœ… ì´ ë¶€ë¶„ì„ ì¶”ê°€í•˜ê±°ë‚˜ 'shift_down' ë“±ìœ¼ë¡œ ë³€ê²½í•˜ë©° í…ŒìŠ¤íŠ¸
          beforePaste: function(data, coords) {
            console.log("--- beforePaste í›… ì‹¤í–‰ ---");
            console.log("í´ë¦½ë³´ë“œ ë°ì´í„° (ì›ë³¸):", data); // [["cell1\tcell2"], ["cell3\tcell4"]]ì™€ ê°™ì€ í˜•íƒœë¥¼ ê¸°ëŒ€
            console.log("ë¶™ì—¬ë„£ì„ ì‹œì‘ ì…€ (ì¢Œí‘œ):", coords);
            console.log("------------------------");
          }
        });

        document.getElementById('FileInput').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;

          const fileName = file.name.toLowerCase();
      
          if (fileName.endsWith('.xlsx') | fileName.endsWith('.csv')) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const data = new Uint8Array(event.target.result);
              const workbook = XLSX.read(data, { type: 'array' });

              const firstSheetName = workbook.SheetNames[0];
              const sheet = workbook.Sheets[firstSheetName];

              const rows = XLSX.utils.sheet_to_json(sheet, {
                header: 1,
                raw: true // âœ… ì„œì‹ ì œê±°í•´ì„œ ì›ë³¸ ìˆ«ì ìœ ì§€
              });

              if (rows.length === 0) return;

              const headers = rows[0];  // âœ… ì—‘ì…€ ì²« ì¤„ì„ Handsontable colHeadersë¡œ ì‚¬ìš©
              const expectedCols = headers.length;

              // âœ… í—¤ë” ì œê±° + ë¹ˆ í–‰ ì œê±°
              const cleaned = rows.slice(1)
                .filter(row => row.some(cell => String(cell ?? "").trim() !== ""))
                .map(row => {
                  while (row.length < expectedCols) row.push("");
                  return row;
                })
              hot.updateSettings({
                data: cleaned,
                colHeaders: headers,
              });
            };
            reader.readAsArrayBuffer(file);
          }
        });
        
        document.getElementById("form").addEventListener("submit", function(e) {
          e.preventDefault();

          const direction = document.getElementById("direction").value.trim();
          const sa_num = document.getElementById("sa_num").value.trim();
          const end_time = document.getElementById("end_time").value.trim();

          if (!direction) {
            alert("âš ï¸ ë°©í–¥ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          if (!sa_num || isNaN(sa_num)) {
            alert("âš ï¸ ìœ íš¨í•œ SA_num ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          if (!end_time || isNaN(end_time) || Number(end_time) <= 0) {
            alert("âš ï¸ ìœ íš¨í•œ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }
          
          document.getElementById("loading").style.display = "block";

          const data = hot.getData();
          
          const payload = {
            data: data,
            direction: direction,
            sa_num: sa_num,
            end_time: end_time
          };

          fetch("/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(json => {
            document.getElementById("loading").style.display = "none";

            const imgTag = `
              <h2>ê²°ê³¼ ì‹œê³µë„</h2>
              <img src="${json.image_url}" width="800">
            `;
              document.getElementById("image-result").innerHTML = imgTag;
          })
          .catch(err => {
            document.getElementById("loading").style.display = "none";
            alert("âŒ ì‹œê³µë„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error(err);
          });
        });

        document.getElementById("saveExcelBtn").addEventListener("click", function(e) {
          e.preventDefault();

          const data = hot.getData();
          const headers = hot.getColHeader();
          const direction = document.getElementById("direction").value.trim();
          const sa_num = document.getElementById("sa_num").value.trim();
          const end_time = document.getElementById("end_time").value.trim();

          // 2ì°¨ì› ë°°ì—´ â†’ ê°ì²´ ë°°ì—´ ë³€í™˜
          const rows = data.map(row => {
          const obj = {};
          headers.forEach((key, idx) => obj[key] = row[idx]);
            return obj;
          });

          fetch("/save_excel_csv", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              rows: rows,
              headers: headers,
              direction: direction,
              sa_num: sa_num,
              end_time: end_time
            })
          })
          .then(res => res.json())
          .then(json => {
            alert("âœ… CSV íŒŒì¼ ì €ì¥ ì™„ë£Œ!\nê²½ë¡œ: " + json.path);
          });
        });
      });
    </script>
</body>
<footer style="margin-top: 50px; color: #0f0f0f; font-size: 14px;">
  â“’ 2025 CityeyeLab. êµì°¨ë¡œ ì‹œê³µë„ ë¶„ì„ ë„êµ¬.
</footer>
</html>
